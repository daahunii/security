# ⚜️File Upload Vulnerability⚜️
### File Upload Vulnerability(파일 업로드 취약점)이란 파일 업로드 기능을 사용하여 공격자가 원하는 웹 쉘을 해당서버에 올려 공격자가 원하는 행동을 취할 수 있게하는 취약점입니다.

*파일 업로드 취약점이 발생하는 이유*

-> 게시판에 확장자가 .php나 .jsp, .asp 등의 확장자를 가진 파일을 업로드 하는 것을 서버에서 막지 않으면 파일 업로드 취약점이 발생하여 공격자가 원하는 공격을 할 수 있게 해줍니다. 서버에서 위와 같은 확장자를 막아놨다해도 공격자가 우회기법을 사용하여 파일을 올릴 수만 있으면 공격은 성공합니다.

<br>

---

<br>

# Low Level

페이지를 살펴보면 파일을 업로드할 수 있도록 구현되어있다.
<img width="699" alt="스크린샷 2021-07-23 오후 4 38 06" src="https://user-images.githubusercontent.com/86994067/126752241-d0ad1896-65c9-4764-980d-3ab319f8b229.png">

다음과 같이 system()함수를 이용한 간단한 리눅스 명령어가 적힌 php 파일을 작성하여 업로드 시켜주면
<img width="503" alt="스크린샷 2021-07-23 오후 4 49 33" src="https://user-images.githubusercontent.com/86994067/126752699-0bc3bb18-9ed3-4355-a85e-7aa82c049a46.png">
<img width="695" alt="스크린샷 2021-07-23 오후 4 54 00" src="https://user-images.githubusercontent.com/86994067/126753001-4a68292f-9bec-442f-91f0-f560d4046882.png">

업로드 성공이라는 메세지와 함께 업로드된 디렉토리의 주소가 나온다.

해당 주소로 들어가서 확인해보면

<img width="765" alt="스크린샷 2021-07-23 오후 4 57 44" src="https://user-images.githubusercontent.com/86994067/126753334-f987d74a-4bef-4e8f-b1b9-7f9889ed7e5e.png">
<img width="1440" alt="스크린샷 2021-07-23 오후 4 59 28" src="https://user-images.githubusercontent.com/86994067/126753357-f66a4bad-8c78-42c4-bcb4-0bcceabb99c3.png">
system() 함수 내 cat 명령어가 실행되면서 공격에 성공했음을 알 수 있다.


<br>


# Medium Level

이번에도 Low 단계에서처럼 php 파일을 업로드 시켜주면

<img width="692" alt="스크린샷 2021-07-23 오후 5 02 43" src="https://user-images.githubusercontent.com/86994067/126753669-f5ad5dc5-2187-4856-9cd3-73d5f9902e99.png">

다음과 같이 확장자명에서 JPEG 나 PNG 파일만 받는다고 메세지가 뜬다.


그렇다면 만들어놓은 php 파일의 확장자명을 다음과 같이 hack.php.PNG로 바꿔서 업로드해주면
업로드 성공이라는 메세지가 출력된다.
<img width="694" alt="스크린샷 2021-07-23 오후 5 06 39" src="https://user-images.githubusercontent.com/86994067/126754096-550e5fcc-b716-44a6-8896-79db0e920ba2.png">

해당 주소로 들어가보면 아무것도 뜨지않는 것을 확인할 수 있다. (실패인 것 같다...)
<img width="1319" alt="스크린샷 2021-07-23 오후 5 07 36" src="https://user-images.githubusercontent.com/86994067/126754273-29469b93-494d-49cb-bedf-82a84b943756.png">


그래서 이번엔 Burp Suite를 활용한 패킷 인터셉트로 확장자명을 거르는 섹션을 건드려보았다.

<img width="1129" alt="스크린샷 2021-07-23 오후 5 42 15" src="https://user-images.githubusercontent.com/86994067/126758038-ba1efc2c-67b2-4d0b-b54d-f7a72289ed04.png">
<img width="1127" alt="스크린샷 2021-07-23 오후 5 43 07" src="https://user-images.githubusercontent.com/86994067/126758042-8bdd1d9f-c9ec-4ae6-9034-6334b88a05cc.png">
<img width="1440" alt="스크린샷 2021-07-23 오후 6 45 58" src="https://user-images.githubusercontent.com/86994067/126765143-003c7d3e-dbcb-4b2a-b42f-c11ce4cd03fd.png">


다음과 같이 text/php -> image/png 로 바꾸어 업로드 시키면

<img width="691" alt="스크린샷 2021-07-23 오후 5 38 02" src="https://user-images.githubusercontent.com/86994067/126757399-cef541c9-130a-4e84-aea9-63d616aaf08e.png">

php 파일이 성공적으로 업로드되는 것을 볼 수 있다.

해당 주소로 들어가보면 명령이 실행되는 것을 확인할 수 있었다.

<img width="1334" alt="스크린샷 2021-07-23 오후 5 39 20" src="https://user-images.githubusercontent.com/86994067/126757650-e84fdb67-8596-426b-8cd7-5c26a0ac60e3.png">
<img width="1440" alt="스크린샷 2021-07-23 오후 5 39 35" src="https://user-images.githubusercontent.com/86994067/126757657-af7c2626-258d-4b35-9255-f27fe9005a60.png">



<br>

# High Level

High 단계에서도 마찬가지로 이전 Medium 단계처럼 php 파일을 업로드가 되지 않고 jpg, jpeg, png 파일만 따로 받는 것을 확인할 수 있다.
<img width="1080" alt="스크린샷 2021-07-23 오후 6 08 41" src="https://user-images.githubusercontent.com/86994067/126761173-d1ca7808-655a-4a12-8c0d-4a47f96c8ef7.png">

그렇다고 Medium 단계에서처럼 Content Type 헤더를 변조해보았지만 통하지 않았다.

위에 php 코드를 보면 getimagesize()라는 함수를 사용해 실제 이미지인지 아닌지 검사를 하는 것을 알 수 있다.
-> 실제 이미지가 아니라면 false로 반환

그래서 이번엔 getimagesize 함수를 우회하기 위해 추가적인 작업으로 "GIF89a"라는 코드를 추가한다. (filename에다가 확장자명 png도 붙인다.)
<img width="1130" alt="스크린샷 2021-07-23 오후 6 43 32" src="https://user-images.githubusercontent.com/86994067/126764984-d8b83387-710f-4642-9972-c58086e5aa1f.png">
<img width="922" alt="스크린샷 2021-07-23 오후 6 44 28" src="https://user-images.githubusercontent.com/86994067/126765001-e5976cf1-1981-4568-a3e1-4ca649c5cdc8.png">
그럼 다음과 같이 업로드에 성공할 수 있다.

마지막으로 해당 주소로 접속해보면 

<img width="1440" alt="스크린샷 2021-07-23 오후 6 45 58" src="https://user-images.githubusercontent.com/86994067/126765155-d84263eb-cb05-4022-8324-4dfc20229f60.png">

웹쉘 실행결과만 출력이 되고 내부 php 코드는 실행되지 않아 공격이 불가능했다.



